syntax = "proto3";

import "google/protobuf/empty.proto";
import "spec/permissions.proto";

option go_package = "github.com/e2b-dev/infra/packages/envd/spec";

package filesystem;

service Filesystem {
    rpc Stat(StatRequest) returns (StatResponse);
    
    rpc CreateFile(CreateFileRequest) returns (google.protobuf.Empty);

    rpc CreateDir(CreateDirRequest) returns (google.protobuf.Empty);
    rpc ListDir(ListDirRequest) returns (ListDirResponse);
    
    rpc CreateLink(CreateLinkRequest) returns (google.protobuf.Empty);
    rpc CreateSymlink(CreateSymlinkRequest) returns (google.protobuf.Empty);

    rpc Watch(WatchRequest) returns (stream FilesystemEvent);
    rpc Rename(MoveRequest) returns (google.protobuf.Empty);
    rpc Remove(RemoveRequest) returns (google.protobuf.Empty);

    rpc Chmod(ChmodRequest) returns (google.protobuf.Empty);
    rpc Chown(ChownRequest) returns (google.protobuf.Empty);

    rpc Copy(CopyRequest) returns (google.protobuf.Empty);
}

message CreateFileRequest {
    string path = 1;
    bool create_parents = 2;
    
    permissions.AccessControl access = 3;
}

message CreateDirRequest {
    string path = 1;
    bool create_parents = 2;
    uint32 mode = 3;

    permissions.AccessControl access = 4;
}

message CreateLinkRequest {
    string source = 1;
    string destination = 2;
    permissions.AccessControl access = 3;
}

message CreateSymlinkRequest {
    string source = 1;
    string destination = 2;
    permissions.AccessControl access = 3;
}

message CopyRequest {
    string source = 1;
    string destination = 2;
    bool recursive = 3;
    permissions.AccessControl access = 4;
}

message ChmodRequest {
    string path = 1;
    uint32 mode = 2;
    permissions.AccessControl access = 3;
}

message ChownRequest {
    string path = 1;
    uint32 uid = 2;
    uint32 gid = 3;
    permissions.AccessControl access = 4;
}

message StatRequest {
    string path = 1;
    permissions.AccessControl access = 2;
}

message StatResponse {
    EntryInfo entry = 1;
}

message RemoveRequest {
    string path = 1;
    bool all = 2;
    permissions.AccessControl access = 3;
}

message MoveRequest {
    string source = 1;
    string destination = 2;
    permissions.AccessControl access = 3;
}

message EntryInfo {
    string name = 1;
    FileType type = 2;
    uint32 mode = 3;
    uint64 size = 4;
    uint64 last_modified = 5;
    permissions.AccessControl owner = 6;

    enum FileType {
        UNKNOWN_FileType = 0;
        FILE = 1;
        DIRECTORY = 2;
        LINK = 3;
        SYMLINK = 4;
    }
}

message ListDirRequest {
    string path = 1;
    permissions.AccessControl access = 2;
}

message ListDirResponse {
    repeated EntryInfo entries = 1;
}

message WatchRequest {
    string path = 1;
    permissions.AccessControl access = 2;
}

message FilesystemEvent {
    string path = 1;
    EventType type = 2;
    EntryInfo entry = 3;

    enum EventType {
        UNKNOWN_EventType = 0;
        CREATE = 1;
        WRITE = 2;
        REMOVE = 3;
        RENAME = 4;
        CHMOD = 5;
    }
}
